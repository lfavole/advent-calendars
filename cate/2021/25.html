{% extends "cate/2021/day.html" %}

{% block content %}
{{ super() }}
<div class="texte">
<style>
body, main {
	display:flex;
	flex-direction:column;
	height:100vh;
}
main {
	margin:8px;
}
.paroles {
	border:2px solid black;
	background-color:rgba(0, 0, 0, 0.2);
	color:black;
	font-size:42px;
	width:1200px;
	max-width:100%;
	height:600px;
	display:flex;
	flex-direction:column;
	margin:auto;
	text-align:center;
}
@media not print {
	body.mode-nuit .paroles {
		background-color:rgba(255, 255, 255, 0.2);
		color:white;
	}
}
@media (max-width: 500px) {
	.paroles {
		font-size:28px;
		height:400px;
		flex:1 0 400px;
	}
}
.paroles audio {
	width:100%;
}
.lignes {
	height:100%;
	overflow-y:auto;
	scroll-behavior:smooth;
	scrollbar-width:none;
}
.lignes div:empty {
	display:none;
}
.lignes div {
	margin:0.5em 0px;
	padding:4px 8px;
	transition:color 0.4s ease-in-out, background-color 0.4s ease-in-out, font-weight 0.4s ease-out;
}
.lignes .act {
	font-weight:bold;
	color:#0d0;
	background-color:rgba(128, 255, 128, 0.3);
}
</style>
<script>
$(async function() {
	var lrc = await (await fetch("../paroles.lrc")).text();
	var lrc2 = lrc.split("\n").map(function(e) {
		var t = e.match(/^\[(\d{2}):(\d{2}\.\d{2})\]/);
		var l = t ? e.match(/^\[\d{2}:\d{2}\.\d{2}\]\s*(.*)\s*$/)[1] : e;
		return {t: t ? t[1] * 60 + t[2] * 1 : null, l: l};
	}).filter(function(e) {
		return e.t != null;
	});
	lrc2.sort(function(a, b) {
		return a.t - b.t;
	});
	/*
	var lrc3 = [];
	$.each(lrc2, function(i, e) {
		lrc3.push({a: e.t, b: lrc2[i + 1] ? lrc2[i + 1].t : d, l: e.l});
	});
	console.log(lrc3);
	*/
	var audio = $("#musique").eq(0);
	var ct = $("<div>").addClass("paroles").insertBefore("audio");
	var el = $("<div>").addClass("lignes").appendTo(ct);
	var a = audio.clone().appendTo(ct);
	audio.remove();
	el.append($("<div>").attr("data-id", -1).html(""));
	for(var i=0, l=lrc2.length; i<l; i++) {
		el.append($("<div>").attr("data-id", i).html(lrc2[i].l));
	}
	var idp = -2;
	a.on("timeupdate", function(evt) {
		var p = {t: 0, l: ""};
		for(var i=0, l=lrc2.length; i<l; i++) {
			if(lrc2[i].t > this.currentTime) break;
			p = lrc2[i];
		}
		var id = i - 1;
		if($(".act", el).attr("data-id") != id) {
			$(".act", el).removeClass("act");
			var l = $("[data-id=" + id + "]", el).addClass("act");
			var t = l.get(0).offsetTop;
			el.scrollTop(((t - el.get(0).offsetTop) + l.height() / 2) - el.height() / 2);
		}
		idp = id;
	});
});
</script>
<audio id="musique" src="../musique.mp3" controls></audio>
</div>
{% endblock %}
